import streamlit as st
import numpy as np
import plotly.graph_objects as go

# ==========================================
# 1. é¡µé¢é…ç½®ä¸æ•™å­¦æƒ…å¢ƒå¯¼å…¥
# ==========================================
st.set_page_config(page_title="æ•°æ™ºåŠ›å­¦äº¤äº’å­¦æ¡ˆ", layout="centered")

st.title("ğŸš€ ç©ºå¤©èµ·è½æ¶ï¼šå‹æ†ç¨³å®šæ€§ä¸æé™è½»é‡åŒ–åšå¼ˆ")
st.markdown("""
**é•¿ç©ºåˆ›æ–°ç­ã€Šææ–™åŠ›å­¦Aã€‹ä¸“å±æ•°å­—ä¼´å­¦èµ„æº** > **æ¢ç©¶ä»»åŠ¡**ï¼šæˆ‘ä»¬ä¸ºæ·±ç©ºæ¢æµ‹å™¨è®¾è®¡ä¸€æ ¹é•¿åº¦ä¸º 1000 mm çš„èµ·è½æ¶æ”¯æ’‘æ†ã€‚åœ¨**ç»™å®šææ–™é‡é‡ï¼ˆæ¨ªæˆªé¢ç§¯ä¸å˜ï¼‰**çš„å‰æä¸‹ï¼Œè¯·æ»‘åŠ¨ä¸‹æ–¹â€œç®¡å£åšåº¦â€æ»‘å—ã€‚è§‚å¯Ÿåœ†ç®¡å¤–å¾„çš„å˜åŒ–ï¼Œå¹¶å¯»æ‰¾é‚£ä¸ªè®©â€œå…¨å±€å¤±ç¨³â€ä¸â€œå±€éƒ¨å¤±ç¨³â€è¾¾æˆå®Œç¾å¹³è¡¡ï¼Œä»è€Œä½¿æ€»æ‰¿è½½åŠ›è¾¾åˆ°å·…å³°çš„ **æœ€ä¼˜å£åš**ï¼
---
""")

# ==========================================
# 2. æ ¸å¿ƒå‚æ•°ä¸äº¤äº’æ§åˆ¶åŒº
# ==========================================
# èˆªç©ºé“åˆé‡‘ææ–™å‚æ•°
E = 70000.0        # å¼¹æ€§æ¨¡é‡ (MPa)
sigma_y = 300.0    # å±ˆæœå¼ºåº¦ (MPa)
L = 1000.0         # å‹æ†é•¿åº¦ (mm)
A = 400.0          # å›ºå®šæ¨ªæˆªé¢ç§¯ (mm^2)ï¼Œä»£è¡¨å›ºå®šé‡é‡

st.header("âš™ï¸ æˆªé¢å‡ ä½•æ‹“æ‰‘ä¼˜åŒ–")
st.caption("åœ¨ä¿æŒæ€»é‡é‡ä¸å˜çš„æ¡ä»¶ä¸‹ï¼Œå°†ç®¡å£å˜è–„ï¼Œæ„å‘³ç€åœ†ç®¡çš„ç›´å¾„ä¼šåŒæ­¥æ‰©å¤§ã€‚")

# æ»‘å—ï¼šè°ƒèŠ‚å£åš t
t_val = st.slider("ç®¡å£åšåº¦ t (mm) ğŸ”„", min_value=0.5, max_value=8.0, value=6.0, step=0.1)

# ==========================================
# 3. ç‰©ç†å¼•æ“ï¼šå¤šé‡å¤±æ•ˆæ¨¡å¼å¹¶å‘è®¡ç®—
# ==========================================
# æ ¹æ® A = 2*pi*R*t è¿‘ä¼¼è®¡ç®—åŠå¾„ R å’Œå¤–å¾„ D
R_val = A / (2 * np.pi * t_val)
D_val = 2 * R_val

# 1. å…¨å±€å¤±ç¨³ä¸´ç•ŒåŠ› (æ¬§æ‹‰å…¬å¼ Euler Buckling)
I_val = np.pi * (R_val**3) * t_val
P_global = (np.pi**2 * E * I_val) / (L**2) / 1000  # è½¬æ¢ä¸º kN

# 2. å±€éƒ¨å¤±ç¨³ä¸´ç•ŒåŠ› (åœ†æŸ±å£³çš±æŠ˜ Local Buckling)
# ç»å…¸åœ†æŸ±å£³è½´å‹å±€éƒ¨å±ˆæ›²ç†è®ºå…¬å¼: sigma_cr = 0.6 * E * (t/R)
P_local = (0.6 * E * (t_val / R_val) * A) / 1000   # è½¬æ¢ä¸º kN

# 3. ææ–™å±ˆæœæé™ (å¼ºåº¦ç ´å)
P_yield = (sigma_y * A) / 1000                     # è½¬æ¢ä¸º kN

# å®é™…æé™æ‰¿è½½åŠ›ä¸ºä¸‰è€…ä¸­çš„æœ€å°å€¼
P_actual = min(P_global, P_local, P_yield)

# ==========================================
# 4. å¯è§†åŒ–ç©ºé—´ï¼šå¤±æ•ˆæ¨¡å¼äº¤å‰æ¼”åŒ–æ›²çº¿
# ==========================================
st.subheader("ğŸ“Š æ‰¿è½½åŠ›æ¼”åŒ–ä¸å¤±æ•ˆè¾¹ç•Œåˆ†æ")

# ç”Ÿæˆç»˜å›¾æ•°ç»„
t_arr = np.linspace(0.5, 8.0, 200)
R_arr = A / (2 * np.pi * t_arr)
I_arr = np.pi * (R_arr**3) * t_arr

Pg_arr = (np.pi**2 * E * I_arr) / (L**2) / 1000
Pl_arr = (0.6 * E * (t_arr / R_arr) * A) / 1000
Py_arr = np.full_like(t_arr, P_yield)
P_eff_arr = np.minimum(np.minimum(Pg_arr, Pl_arr), Py_arr)

fig = go.Figure()

# ç»˜åˆ¶ä¸‰æ¡ç†è®ºè¾¹ç•Œæ›²çº¿
fig.add_trace(go.Scatter(x=t_arr, y=Pg_arr, mode='lines', name='å…¨å±€å¤±ç¨³è¾¹ç•Œ (Euler)', line=dict(color='#1f77b4', dash='dash')))
fig.add_trace(go.Scatter(x=t_arr, y=Pl_arr, mode='lines', name='å±€éƒ¨å±ˆæ›²è¾¹ç•Œ (Local)', line=dict(color='#d62728', dash='dash')))
fig.add_trace(go.Scatter(x=t_arr, y=Py_arr, mode='lines', name='ææ–™å±ˆæœæé™ (Yield)', line=dict(color='gray', dash='dot')))

# ç»˜åˆ¶å®é™…æœ‰æ•ˆæ‰¿è½½åŠ›åŒ…ç»œçº¿ (æœ¨æ¡¶æ•ˆåº”åº•çº¿)
fig.add_trace(go.Scatter(x=t_arr, y=P_eff_arr, mode='lines', name='âœ… å®é™…æœ‰æ•ˆæ‰¿è½½åŠ›', line=dict(color='#2ca02c', width=4)))

# æ ‡è®°å½“å‰è®¾è®¡ç‚¹
fig.add_trace(go.Scatter(
    x=[t_val], y=[P_actual], mode='markers', 
    marker=dict(size=14, color='#ff7f0e', symbol='star', line=dict(width=2, color='black')), 
    name=f'å½“å‰è®¾è®¡ç‚¹ (t={t_val}mm)',
    hovertemplate='å£åš: %{x:.1f} mm<br>æ‰¿è½½åŠ›: %{y:.1f} kN<extra></extra>'
))

# å›¾è¡¨å¸ƒå±€
fig.update_layout(
    font=dict(family="Microsoft YaHei, SimHei, Arial, sans-serif"),
    xaxis_title="ç®¡å£åšåº¦ t (mm)  [å‘å·¦æ»‘åŠ¨ä»£è¡¨å°†ç®¡å£å‰Šè–„]",
    yaxis_title="æé™æ‰¿è½½åŠ› P (kN)",
    yaxis=dict(range=[0, min(150, max(Pg_arr)*1.1)]),
    legend=dict(x=0.02, y=0.98, bgcolor="rgba(255,255,255,0.8)"),
    margin=dict(l=0, r=0, t=20, b=0),
    height=450,
    hovermode="x unified"
)
st.plotly_chart(fig, use_container_width=True)

# ==========================================
# 5. æ•°æ®ä»ªè¡¨æ¿ä¸æ™ºèƒ½å·¥ç¨‹è­¦å‘Š
# ==========================================
col1, col2, col3 = st.columns(3)
with col1:
    st.metric("å½“å‰ç®¡å£åšåº¦ (t)", f"{t_val:.1f} mm")
with col2:
    st.metric("å¤–æ‰©åç®¡å¤–å¾„ (D)", f"{D_val:.1f} mm")
with col3:
    st.metric("ğŸ† å®é™…æé™æ‰¿è½½åŠ›", f"{P_actual:.1f} kN")

st.divider()
st.subheader("âš ï¸ å·¥ç¨‹çŠ¶æ€è¯Šæ–­")

# å¤±æ•ˆæ¨¡å¼æ™ºèƒ½åˆ¤æ–­
if P_actual == P_global:
    st.warning("ğŸ“‰ **å½“å‰å¤±æ•ˆæ¨¡å¼ï¼šå…¨å±€å¤±ç¨³ (Euler Buckling)**ã€‚ç®¡å£è¾ƒåšï¼Œä½†æ•´ä½“æƒ¯æ€§çŸ©ä¸è¶³ã€‚å‹æ†ä¼šåƒé¢æ¡ä¸€æ ·å‘ç”Ÿæ•´ä½“å¼¯æ›²ã€‚å»ºè®®ç»§ç»­å‡è–„ç®¡å£ä»¥æ‰©å¤§å¤–å¾„ï¼")
elif P_actual == P_local:
    st.error("ğŸš¨ **å±é™©è­¦å‘Šï¼šå±€éƒ¨å±ˆæ›² (Local Buckling)**ã€‚ç®¡å£è¢«å‰Šå¾—è¿‡è–„ï¼Œå·²å˜æˆæ˜“æ‹‰ç½ç»“æ„ï¼å‹æ†æ•´ä½“è¿˜æœªå¼¯æ›²ï¼Œç®¡å£å·²ç‡å…ˆå‘ç”Ÿå±€éƒ¨çš±æŠ˜åå¡Œã€‚è®¾è®¡å·²è¶Šè¿‡å®‰å…¨çº¢çº¿ï¼")
else:
    st.success("ğŸ”¨ **å½“å‰å¤±æ•ˆæ¨¡å¼ï¼šææ–™å±ˆæœ (Yielding)**ã€‚æ‚¨æ‰¾åˆ°äº†æä¸ºä¼˜ç§€çš„å°ºå¯¸åŒºé—´ï¼ç»“æ„çš„ç¨³å®šæ€§å·²è¢«å……åˆ†ä¼˜åŒ–ï¼Œæœ€ç»ˆç ´åç”±ææ–™è‡ªèº«çš„æé™å¼ºåº¦å†³å®šï¼Œæ²¡æœ‰é€ æˆä»»ä½•ç¨³å®šæ€§æ½œåŠ›çš„æµªè´¹ã€‚")
